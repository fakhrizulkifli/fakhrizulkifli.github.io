<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>BSD Hypervisor - pci_fbuf NULL Pointer Dereference | Fakhri Zulkifli</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69613510-1', 'auto');
    ga('send', 'pageview');

</script>


    <link rel="shortcut icon" href="/images/favicon.jpg">
</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <h1 class="">Fakhri Zulkifli</h1>
    <p>
    <div align="center">
    <a href="https://github.com/fakhrizulkifli" target="_blank"><span class="string">https://github.com/fakhrizulkifli</a>
    â€¢
    <a href="https://twitter.com/d0lph1n98" target="_blank"><span class="string">https://twitter.com/d0lph1n98</a>
    </div>
    </p>
  </div>
</header>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="/">home</a></li>
          <li><a href="/blog/">blog</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>BSD Hypervisor - pci_fbuf NULL Pointer Dereference</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Aug 17, 2019
        
        
    </p>
  </header>

  <article class="post-content">
  <p>NOTE: This also works in <a href="https://github.com/machyve/xhyve" target="_blank">xhyve hypervisor</a>.</p>

<p>Affected code:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 0x00000000002317ec &lt;+108&gt;:	mov $0x206519,%edi
 0x00000000002317f1 &lt;+113&gt;:	xor %eax,%eax
 0x00000000002317f3 &lt;+115&gt;:	mov %r9d,%esi
 0x00000000002317f6 &lt;+118&gt;:	callq 0x24aa00 &lt;printf@plt&gt;
 0x00000000002317fb &lt;+123&gt;:	mov 0xc8(%rbx),%rax
=&gt; 0x0000000000231802 &lt;+130&gt;:	cmpl $0x0,(%rax)
 0x0000000000231805 &lt;+133&gt;:	movzwl 0xc(%rbx),%eax
 0x0000000000231809 &lt;+137&gt;:	je 0x231830 &lt;pci_fbuf_write+176&gt;
 0x000000000023180b &lt;+139&gt;:	test %ax,%ax
 0x000000000023180e &lt;+142&gt;:	je 0x23185d &lt;pci_fbuf_write+221&gt;
 0x0000000000231810 &lt;+144&gt;:	cmpw $0x0,0xe(%rbx)
 0x0000000000231815 &lt;+149&gt;:	je 0x23185d &lt;pci_fbuf_write+221&gt;
</code></pre></div></div>

<p>Proof-of-Crash:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread 13 "vcpu 2" received signal SIGSEGV, Segmentation fault.
[Switching to LWP 100571 of process 4094]
0x0000000000231802 in pci_fbuf_write (ctx=&lt;optimized out&gt;, vcpu=&lt;optimized out&gt;, pi=&lt;optimized out&gt;, baridx=&lt;optimized out&gt;, offset=&lt;optimized out&gt;, size=&lt;optimized out&gt;,
 value=1953719668) at /usr/src/usr.sbin/bhyve/pci_fbuf.c:166
166	if (!sc-&gt;gc_image-&gt;vgamode &amp;&amp; sc-&gt;memregs.width == 0 &amp;&amp;
(gdb) p sc-&gt;gc_image
$1 = (struct bhyvegc_image *) 0x0
(gdb) bt
#0 0x0000000000231802 in pci_fbuf_write (ctx=&lt;optimized out&gt;, vcpu=&lt;optimized out&gt;, pi=&lt;optimized out&gt;, baridx=&lt;optimized out&gt;, offset=&lt;optimized out&gt;, size=&lt;optimized out&gt;,
 value=1953719668) at /usr/src/usr.sbin/bhyve/pci_fbuf.c:166
#1 0x0000000000230522 in pci_emul_mem_handler (ctx=0x80028e080, vcpu=2, dir=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, size=4, val=0x7fffde9f2d40, arg1=0x800a9aa00, arg2=0)
 at /usr/src/usr.sbin/bhyve/pci_emul.c:415
#2 0x0000000000224ae4 in mem_write (ctx=0x80028e080, vcpu=2, gpa=3, wval=1953719668, size=0, arg=0x0) at /usr/src/usr.sbin/bhyve/mem.c:162
#3 0x00000000002486ae in emulate_mov (vm=&lt;optimized out&gt;, vcpuid=&lt;optimized out&gt;, gpa=&lt;optimized out&gt;, vie=&lt;optimized out&gt;, memread=&lt;optimized out&gt;,
 memwrite=&lt;optimized out&gt;, arg=&lt;optimized out&gt;) at /usr/src/sys/amd64/vmm/vmm_instruction_emul.c:517
#4 vmm_emulate_instruction (vm=&lt;optimized out&gt;, vcpuid=&lt;optimized out&gt;, gpa=&lt;optimized out&gt;, vie=&lt;optimized out&gt;, paging=&lt;optimized out&gt;, memread=&lt;optimized out&gt;,
 memwrite=0x224ab0 &lt;mem_write&gt;, memarg=0x800aad100) at /usr/src/sys/amd64/vmm/vmm_instruction_emul.c:1510
#5 0x000000000022448f in emulate_mem_cb (ctx=0x80028e080, vcpu=2, paddr=34370857472, mr=0x0, arg=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/mem.c:238
#6 0x00000000002243da in access_memory (ctx=0x80028e080, vcpu=2, paddr=3221241856, cb=0x224470 &lt;emulate_mem_cb&gt;, arg=0x7fffde9f2ec8) at /usr/src/usr.sbin/bhyve/mem.c:215
#7 0x00000000002242b9 in emulate_mem (ctx=0x80028e080, vcpu=2, paddr=34370857472, vie=&lt;optimized out&gt;, paging=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/mem.c:251
#8 0x000000000021bc75 in vmexit_inst_emul (ctx=0x80028e080, vmexit=0x24f780 &lt;vmexit+272&gt;, pvcpu=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/bhyverun.c:630
#9 0x000000000021b6da in vm_loop (ctx=0x80028e080, vcpu=2, startrip=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/bhyverun.c:748
#10 0x000000000021a969 in fbsdrun_start_thread (param=0x24e050 &lt;mt_vmm_info+48&gt;) at /usr/src/usr.sbin/bhyve/bhyverun.c:353
#11 0x000000080061b776 in ?? () from /lib/libthr.so.3
#12 0x0000000000000000 in ?? ()
Backtrace stopped: Cannot access memory at address 0x7fffde9f3000

(gdb) i registers
rax 0x0 0
rbx 0x800aec000 34371190784
rcx 0x3 3
rdx 0x800a9aa00 34370857472
rsi 0x2 2
rdi 0x80028e080 34362417280
rbp 0x7fffde9f2cd0 0x7fffde9f2cd0
rsp 0x7fffde9f2cc0 0x7fffde9f2cc0
r8 0x0 0
r9 0x4 4
r10 0x231780 2299776
r11 0x7fffde9f2d40 140736928361792
r12 0x0 0
r13 0x80028e080 34362417280
r14 0x800a9aa00 34370857472
r15 0x24b430 2405424
rip 0x231802 0x231802 &lt;pci_fbuf_write+130&gt;
eflags 0x10297 [ CF PF AF SF IF RF ]
cs 0x43 67
ss 0x3b 59
ds &lt;unavailable&gt;
es &lt;unavailable&gt;
fs &lt;unavailable&gt;
gs &lt;unavailable&gt;
fs_base 0x800ac98d0 34371049680
gs_base 0x0 0
</code></pre></div></div>

  </article>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = '';
    var disqus_config = function () {
        this.page.identifier = "/blog/bhyve_fbuf_null_deref/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      
    </footer>
  </div>
</div>


      </div>
    </body>
</html>
