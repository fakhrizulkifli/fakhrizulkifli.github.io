<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Fakhri Zulkifli</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap-4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/fontawesome-5.13.0/css/fontawesome.css">
    <link rel="stylesheet" href="/css/fontawesome-5.13.0/css/brands.css">
    <link rel="stylesheet" href="/css/fontawesome-5.13.0/css/solid.css">
    <link rel="stylesheet" href="/css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69613510-1', 'auto');
    ga('send', 'pageview');

</script>


    <link rel="shortcut icon" href="/images/favicon.jpg">
</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2" style="margin: auto">
    <h1 class="">Fakhri Zulkifli</h1>
    <p>
    <div style="margin: auto">
    <a href="https://github.com/fakhrizulkifli" target="_blank"><span style="font-size: large" class="fab fa-github-square"></span></a>
    <a href="https://twitter.com/d0lph1n98" target="_blank"><span style="font-size: large" class="fab fa-twitter-square"></span></a>
    <a href="https://linkedin.com/in/fakhrizulkifli" target="_blank"><span style="font-size: large" class="fab fa-linkedin"></span></a>
    </div>
    </p>
  </div>
</header>

<div class="row">
  <div style="width:-webkit-fill-available">
    <div class="menu">
      <ul>
          <li><a href="/blog/">/root</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div style="width:-webkit-fill-available">
            <main>
            <div class="post">

  <header class="post-header">
    <h1 style="text-align: center">IPv6 Local Neighbor Discovery Using Router Advertisement</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Aug 18, 2019
        
        
    </p>
  </header>

  <article class="post-content">
  <p>Back in March 2016, i had decided to learn more about IPv6 and to do so I came out with an idea to build a network scanner specifically for IPv6 network which can be found <a href="https://github.com/fakhrizulkifli/6Map" target="_blank">here</a> and of course, it is unfinished!. During the development, I relied heavily on rfc4861 specification to utilize the Neighbor Solicitation to discover hosts on link-local.</p>

<p>So the idea was to send a Router Advertisement message to the multicast address for all available IPv6 devices within the same network segment. Further reading and googling left me a mailing list thread which discussed some issues in a Metasploit’s auxiliary <a href="https://www.rapid7.com/db/modules/auxiliary/scanner/discovery/ipv6_neighbor_router_advertisement" target="_blank">scanner</a>. Every time the scanner scans the entire network, it leaves the hosts in a denial-of-service state to the IPv6 network due to the misconfigured routing table. Turned out the scanner was sending the RA message with a lifetime of 1800 seconds. So within this timeframe, the hosts will not be able to have proper IPv6 connection until the entry of router advertised is flushed away from the routing table. So i created a patch for the scanner and set the RA lifetime to 0 indicating it is not a default router and thus not going to be appeared in the host’s routing table.</p>

<p>Patch diff:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">From b1e9f44ca26072ba9594ef7d034e47283f220b2f Mon Sep 17 00:00:00 2001
From: Fakhri Zulkifli &lt;d0lph1n98@yahoo.com&gt;
Date: Sun, 6 Mar 2016 03:23:37 +0800
Subject: [PATCH] IPv6 Neighbor Advertisement Enhancement
</span>
http://seclists.org/nmap-dev/2011/q2/79

1. Shorten router advertisement payload lifetime.
<span class="p">2. Randomize address prefix.
3. Prevent from getting into default router list.
---
</span> .../ipv6_neighbor_router_advertisement.rb     | 25 +++++++++++--------
 1 file changed, 14 insertions(+), 11 deletions(-)

diff --git a/modules/auxiliary/scanner/discovery/ipv6_neighbor_router_advertisement.rb b/modules/auxiliary/scanner/discovery/ipv6_neighbor_router_advertisement.rb
<span class="gh">index 08e6967dfe1..4b1d988dce2 100644
</span><span class="gd">--- a/modules/auxiliary/scanner/discovery/ipv6_neighbor_router_advertisement.rb
</span><span class="gi">+++ b/modules/auxiliary/scanner/discovery/ipv6_neighbor_router_advertisement.rb
</span><span class="p">@@ -20,7 +20,7 @@</span> def initialize
         the host portion of the IPv6 address.  Use NDP host solicitation to
         determine if the IP address is valid'
     },
<span class="gd">-    'Author'      =&gt; 'wuntee',
</span><span class="gi">+    'Author'      =&gt; 'wuntee, d0lph1n98',
</span>     'License'     =&gt; MSF_LICENSE,
     'References'    =&gt;
     [
<span class="p">@@ -33,20 +33,22 @@</span> def initialize
       OptInt.new('TIMEOUT_NEIGHBOR', [true, "Time (seconds) to listen for a solicitation response.", 1])
     ], self.class)
 
<span class="gd">-    register_advanced_options(
-      [
-        OptString.new('PREFIX', [true, "Prefix that each host should get an IPv6 address from",
-          "2001:1234:DEAD:BEEF::"]
-        )
-      ], self.class)
-
</span>     deregister_options('SNAPLEN', 'FILTER', 'RHOST', 'PCAPFILE')
   end
 
<span class="gi">+  def generate_prefix()
+    max = 16 ** 4
+    prefix = "2001::"
+    (0..2).each do
+        prefix &lt;&lt; "%x::" % Random.rand(0..max)
+    end
+    return prefix
+  end
+
</span>   def listen_for_neighbor_solicitation(opts = {})
     hosts = []
     timeout = opts['TIMEOUT'] || datastore['TIMEOUT']
<span class="gd">-    prefix = opts['PREFIX'] || datastore['PREFIX']
</span><span class="gi">+    prefix = @prefix
</span> 
     max_epoch = ::Time.now.to_i + timeout
     autoconf_prefix = IPAddr.new(prefix).to_string().slice(0..19)
<span class="p">@@ -94,7 +96,7 @@</span> def create_router_advertisment(opts={})
     smac = @smac
     shost = opts['SHOST'] || datastore['SHOST'] || ipv6_link_address
     lifetime = opts['LIFETIME'] || datastore['TIMEOUT']
<span class="gd">-    prefix = opts['PREFIX'] || datastore['PREFIX']
</span><span class="gi">+    prefix = @prefix
</span>     plen = 64
     dmac = "33:33:00:00:00:01"
 
<span class="p">@@ -141,7 +143,7 @@</span> def router_advertisement_payload
     checksum = 0
     hop_limit = 0
     flags = 0x08
<span class="gd">-    lifetime = 1800
</span><span class="gi">+    lifetime = 0
</span>     reachable = 0
     retrans = 0
     [type, code, checksum, hop_limit, flags,
<span class="p">@@ -152,6 +154,7 @@</span> def run
     # Start capture
     open_pcap({'FILTER' =&gt; "icmp6"})
 
<span class="gi">+    @prefix = generate_prefix()
</span>     @netifaces = true
     if not netifaces_implemented?
       print_error("WARNING : Pcaprub is not uptodate, some functionality will not be available")

</code></pre></div></div>

<hr />
<p>References:</p>
<ol>
  <li>https://github.com/fakhrizulkifli/6Map</li>
  <li>https://www.rapid7.com/db/modules/auxiliary/scanner/discovery/ipv6_neighbor_router_advertisement</li>
  <li>https://seclists.org/nmap-dev/2011/q2/79</li>
  <li>http://www.rfcreader.com/#rfc4861</li>
  <li>http://www.rfcreader.com/#rfc6104</li>
</ol>

  </article>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = '';
    var disqus_config = function () {
        this.page.identifier = "/ipv6_neighbor_router_advertisement/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div style="width:-webkit-fill-available">
    <footer>
      
    </footer>
  </div>
</div>


      </div>
    </body>
</html>
