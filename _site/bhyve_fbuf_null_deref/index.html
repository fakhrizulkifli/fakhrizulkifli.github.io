<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Fakhri Zulkifli</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap-4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/fontawesome-5.13.0/css/fontawesome.css">
    <link rel="stylesheet" href="/css/fontawesome-5.13.0/css/brands.css">
    <link rel="stylesheet" href="/css/fontawesome-5.13.0/css/solid.css">
    <link rel="stylesheet" href="/css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69613510-1', 'auto');
    ga('send', 'pageview');

</script>


    <link rel="shortcut icon" href="/images/favicon.jpg">
</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2" style="margin: auto">
    <h1 class="">Fakhri Zulkifli</h1>
    <p>
    <div style="margin: auto">
    <a href="https://github.com/fakhrizulkifli" target="_blank"><span style="font-size: large" class="fab fa-github-square"></span></a>
    <a href="https://twitter.com/d0lph1n98" target="_blank"><span style="font-size: large" class="fab fa-twitter-square"></span></a>
    <a href="https://linkedin.com/in/fakhrizulkifli" target="_blank"><span style="font-size: large" class="fab fa-linkedin"></span></a>
    </div>
    </p>
  </div>
</header>

<div class="row">
  <div style="width:-webkit-fill-available">
    <div class="menu">
      <ul>
          <li><a href="/blog/">/root</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div style="width:-webkit-fill-available">
            <main>
            <div class="post">

  <header class="post-header">
    <h1 style="text-align: center">BSD Hypervisor - pci_fbuf NULL Pointer Dereference</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Aug 17, 2019
        
        
    </p>
  </header>

  <article class="post-content">
  <p>NOTE: This also works in <a href="https://github.com/machyve/xhyve" target="_blank">xhyve hypervisor</a>.</p>

<p>Affected code:</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="mh">0x00000000002317ec</span> <span class="o">&lt;+</span><span class="mi">108</span><span class="o">&gt;:</span>	<span class="k">mov</span> <span class="err">$</span><span class="mh">0x206519</span><span class="p">,</span><span class="err">%</span><span class="n">edi</span>
 <span class="mh">0x00000000002317f1</span> <span class="o">&lt;+</span><span class="mi">113</span><span class="o">&gt;:</span>	<span class="k">xor</span> <span class="err">%</span><span class="n">eax</span><span class="p">,</span><span class="err">%</span><span class="n">eax</span>
 <span class="mh">0x00000000002317f3</span> <span class="o">&lt;+</span><span class="mi">115</span><span class="o">&gt;:</span>	<span class="k">mov</span> <span class="err">%</span><span class="n">r9d</span><span class="p">,</span><span class="err">%</span><span class="n">esi</span>
 <span class="mh">0x00000000002317f6</span> <span class="o">&lt;+</span><span class="mi">118</span><span class="o">&gt;:</span>	<span class="n">callq</span> <span class="mh">0x24aa00</span> <span class="o">&lt;</span><span class="n">printf</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
 <span class="mh">0x00000000002317fb</span> <span class="o">&lt;+</span><span class="mi">123</span><span class="o">&gt;:</span>	<span class="k">mov</span> <span class="mh">0xc8</span><span class="p">(</span><span class="err">%</span><span class="n">rbx</span><span class="p">),</span><span class="err">%</span><span class="n">rax</span>
<span class="o">=&gt;</span> <span class="mh">0x0000000000231802</span> <span class="o">&lt;+</span><span class="mi">130</span><span class="o">&gt;:</span>	<span class="n">cmpl</span> <span class="err">$</span><span class="mh">0x0</span><span class="p">,(</span><span class="err">%</span><span class="n">rax</span><span class="p">)</span>
 <span class="mh">0x0000000000231805</span> <span class="o">&lt;+</span><span class="mi">133</span><span class="o">&gt;:</span>	<span class="n">movzwl</span> <span class="mh">0xc</span><span class="p">(</span><span class="err">%</span><span class="n">rbx</span><span class="p">),</span><span class="err">%</span><span class="n">eax</span>
 <span class="mh">0x0000000000231809</span> <span class="o">&lt;+</span><span class="mi">137</span><span class="o">&gt;:</span>	<span class="k">je</span> <span class="mh">0x231830</span> <span class="o">&lt;</span><span class="n">pci_fbuf_write</span><span class="o">+</span><span class="mi">176</span><span class="o">&gt;</span>
 <span class="mh">0x000000000023180b</span> <span class="o">&lt;+</span><span class="mi">139</span><span class="o">&gt;:</span>	<span class="k">test</span> <span class="err">%</span><span class="n">ax</span><span class="p">,</span><span class="err">%</span><span class="n">ax</span>
 <span class="mh">0x000000000023180e</span> <span class="o">&lt;+</span><span class="mi">142</span><span class="o">&gt;:</span>	<span class="k">je</span> <span class="mh">0x23185d</span> <span class="o">&lt;</span><span class="n">pci_fbuf_write</span><span class="o">+</span><span class="mi">221</span><span class="o">&gt;</span>
 <span class="mh">0x0000000000231810</span> <span class="o">&lt;+</span><span class="mi">144</span><span class="o">&gt;:</span>	<span class="n">cmpw</span> <span class="err">$</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0xe</span><span class="p">(</span><span class="err">%</span><span class="n">rbx</span><span class="p">)</span>
 <span class="mh">0x0000000000231815</span> <span class="o">&lt;+</span><span class="mi">149</span><span class="o">&gt;:</span>	<span class="k">je</span> <span class="mh">0x23185d</span> <span class="o">&lt;</span><span class="n">pci_fbuf_write</span><span class="o">+</span><span class="mi">221</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Proof-of-Crash:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread 13 <span class="s2">"vcpu 2"</span> received signal SIGSEGV, Segmentation fault.
<span class="o">[</span>Switching to LWP 100571 of process 4094]
0x0000000000231802 <span class="k">in </span>pci_fbuf_write <span class="o">(</span><span class="nv">ctx</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">vcpu</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">pi</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">baridx</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">offset</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">size</span><span class="o">=</span>&lt;optimized out&gt;,
 <span class="nv">value</span><span class="o">=</span>1953719668<span class="o">)</span> at /usr/src/usr.sbin/bhyve/pci_fbuf.c:166
166	<span class="k">if</span> <span class="o">(!</span>sc-&gt;gc_image-&gt;vgamode <span class="o">&amp;&amp;</span> sc-&gt;memregs.width <span class="o">==</span> 0 <span class="o">&amp;&amp;</span>
<span class="o">(</span>gdb<span class="o">)</span> p sc-&gt;gc_image
<span class="nv">$1</span> <span class="o">=</span> <span class="o">(</span>struct bhyvegc_image <span class="k">*</span><span class="o">)</span> 0x0
<span class="o">(</span>gdb<span class="o">)</span> bt
<span class="c">#0 0x0000000000231802 in pci_fbuf_write (ctx=&lt;optimized out&gt;, vcpu=&lt;optimized out&gt;, pi=&lt;optimized out&gt;, baridx=&lt;optimized out&gt;, offset=&lt;optimized out&gt;, size=&lt;optimized out&gt;,</span>
 <span class="nv">value</span><span class="o">=</span>1953719668<span class="o">)</span> at /usr/src/usr.sbin/bhyve/pci_fbuf.c:166
<span class="c">#1 0x0000000000230522 in pci_emul_mem_handler (ctx=0x80028e080, vcpu=2, dir=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, size=4, val=0x7fffde9f2d40, arg1=0x800a9aa00, arg2=0)</span>
 at /usr/src/usr.sbin/bhyve/pci_emul.c:415
<span class="c">#2 0x0000000000224ae4 in mem_write (ctx=0x80028e080, vcpu=2, gpa=3, wval=1953719668, size=0, arg=0x0) at /usr/src/usr.sbin/bhyve/mem.c:162</span>
<span class="c">#3 0x00000000002486ae in emulate_mov (vm=&lt;optimized out&gt;, vcpuid=&lt;optimized out&gt;, gpa=&lt;optimized out&gt;, vie=&lt;optimized out&gt;, memread=&lt;optimized out&gt;,</span>
 <span class="nv">memwrite</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">arg</span><span class="o">=</span>&lt;optimized out&gt;<span class="o">)</span> at /usr/src/sys/amd64/vmm/vmm_instruction_emul.c:517
<span class="c">#4 vmm_emulate_instruction (vm=&lt;optimized out&gt;, vcpuid=&lt;optimized out&gt;, gpa=&lt;optimized out&gt;, vie=&lt;optimized out&gt;, paging=&lt;optimized out&gt;, memread=&lt;optimized out&gt;,</span>
 <span class="nv">memwrite</span><span class="o">=</span>0x224ab0 &lt;mem_write&gt;, <span class="nv">memarg</span><span class="o">=</span>0x800aad100<span class="o">)</span> at /usr/src/sys/amd64/vmm/vmm_instruction_emul.c:1510
<span class="c">#5 0x000000000022448f in emulate_mem_cb (ctx=0x80028e080, vcpu=2, paddr=34370857472, mr=0x0, arg=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/mem.c:238</span>
<span class="c">#6 0x00000000002243da in access_memory (ctx=0x80028e080, vcpu=2, paddr=3221241856, cb=0x224470 &lt;emulate_mem_cb&gt;, arg=0x7fffde9f2ec8) at /usr/src/usr.sbin/bhyve/mem.c:215</span>
<span class="c">#7 0x00000000002242b9 in emulate_mem (ctx=0x80028e080, vcpu=2, paddr=34370857472, vie=&lt;optimized out&gt;, paging=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/mem.c:251</span>
<span class="c">#8 0x000000000021bc75 in vmexit_inst_emul (ctx=0x80028e080, vmexit=0x24f780 &lt;vmexit+272&gt;, pvcpu=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/bhyverun.c:630</span>
<span class="c">#9 0x000000000021b6da in vm_loop (ctx=0x80028e080, vcpu=2, startrip=&lt;optimized out&gt;) at /usr/src/usr.sbin/bhyve/bhyverun.c:748</span>
<span class="c">#10 0x000000000021a969 in fbsdrun_start_thread (param=0x24e050 &lt;mt_vmm_info+48&gt;) at /usr/src/usr.sbin/bhyve/bhyverun.c:353</span>
<span class="c">#11 0x000000080061b776 in ?? () from /lib/libthr.so.3</span>
<span class="c">#12 0x0000000000000000 in ?? ()</span>
Backtrace stopped: Cannot access memory at address 0x7fffde9f3000

<span class="o">(</span>gdb<span class="o">)</span> i registers
rax 0x0 0
rbx 0x800aec000 34371190784
rcx 0x3 3
rdx 0x800a9aa00 34370857472
rsi 0x2 2
rdi 0x80028e080 34362417280
rbp 0x7fffde9f2cd0 0x7fffde9f2cd0
rsp 0x7fffde9f2cc0 0x7fffde9f2cc0
r8 0x0 0
r9 0x4 4
r10 0x231780 2299776
r11 0x7fffde9f2d40 140736928361792
r12 0x0 0
r13 0x80028e080 34362417280
r14 0x800a9aa00 34370857472
r15 0x24b430 2405424
rip 0x231802 0x231802 &lt;pci_fbuf_write+130&gt;
eflags 0x10297 <span class="o">[</span> CF PF AF SF IF RF <span class="o">]</span>
cs 0x43 67
ss 0x3b 59
ds &lt;unavailable&gt;
es &lt;unavailable&gt;
fs &lt;unavailable&gt;
gs &lt;unavailable&gt;
fs_base 0x800ac98d0 34371049680
gs_base 0x0 0
</code></pre></div></div>

<hr />
<p>References:</p>
<ol>
  <li>https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=240272</li>
</ol>

  </article>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = '';
    var disqus_config = function () {
        this.page.identifier = "/bhyve_fbuf_null_deref/";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div style="width:-webkit-fill-available">
    <footer>
      
    </footer>
  </div>
</div>


      </div>
    </body>
</html>
